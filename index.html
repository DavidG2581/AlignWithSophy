<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Align with Sophy | Online Yoga Training</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav>
      <div class="nav-container">
        <a class="brand" href="index.html">Align with Sophy</a>
        <ul class="nav-links">
          <li class="home-link"><a href="index.html">Home</a></li>
          <li><a href="hatha.html">Hatha</a></li>
          <li><a href="vinyasa.html">Vinyasa</a></li>
          <li><a href="yin.html">Yin</a></li>
          <li><a href="restorative.html">Restorative</a></li>
          <li><a href="members.html">Members</a></li>
          <li><a href="video-library.html">Programs</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li class="login-link" id="nav-auth"><a href="index.html#member-access">Login</a></li>
        </ul>
      </div>
    </nav>

    <header class="hero">
      <!-- Test connection from home desktop -->
      <h1>Align with Sophy Online</h1>
      <p>Personalized online yoga training that meets you wherever you are.</p>
      <a class="hero-cta" href="#about">Discover Your Flow</a>
    </header>

    <main>
      <section id="about" class="content-section intro">
        <h2>Online Yoga Crafted for Your Life</h2>
        <p>
          Align with Sophy delivers live and on-demand yoga sessions that adapt
          to your needs, schedule, and space. Whether you are beginning your
          practice or expanding your journey, our virtual studio pairs mindful
          sequencing with compassionate coaching to deepen strength, mobility,
          and self-connection.
        </p>
        <p>
          Choose from guided classes, private coaching, and curated learning
          paths that blend breathwork, meditation, and restorative tools. Free
          members enjoy regular community updates and select classes, while paid
          members unlock premium video courses, downloadable resources, and an
          exclusive member portal for tracking progress.
        </p>
      </section>

      <section class="content-section practice-overview">
        <h2>Explore Our Signature Yoga Paths</h2>
        <div class="style-grid">
          <article class="style-card">
            <h3><a href="hatha.html">Hatha Yoga</a></h3>
            <p>
              Slow, steady alignment-focused practices that build confidence
              through foundational postures and mindful breath awareness.
            </p>
          </article>
          <article class="style-card">
            <h3><a href="vinyasa.html">Vinyasa Yoga</a></h3>
            <p>
              Dynamic, breath-led flows designed to generate heat, cultivate
              stamina, and encourage creative movement transitions.
            </p>
          </article>
          <article class="style-card">
            <h3><a href="yin.html">Yin Yoga</a></h3>
            <p>
              Nourishing holds that target connective tissues, invite stillness,
              and create space for deep release and reflection.
            </p>
          </article>
          <article class="style-card">
            <h3><a href="restorative.html">Restorative Yoga</a></h3>
            <p>
              Gentle, prop-supported sequences that soothe the nervous system
              and guide you into profound restfulness.
            </p>
          </article>
        </div>
      </section>

      <section class="content-section membership">
        <h2>Membership Tiers & Premium Access</h2>
        <div class="two-column">
          <div class="info-card">
            <h3>Free Community Membership</h3>
            <ul>
              <li>Monthly live community class invitations</li>
              <li>Wellness newsletters with practice tips</li>
              <li>
                Access to purchasable YouTube bundles on the
                <a href="video-library.html">Programs page</a>
              </li>
            </ul>
          </div>
          <div class="info-card">
            <h3>Paid Studio Membership</h3>
            <ul>
              <li>Unlimited access to premium video courses</li>
              <li>
                Guided programs inside the <a href="members.html">Members hub</a>
              </li>
              <li>Personalized practice roadmap and progress tracking</li>
            </ul>
          </div>
        </div>
        <p>
          We partner with a secure third-party payment solution. Once a payment
          is confirmed, the associated Amazon Cognito user account is upgraded,
          automatically granting access to the member-only content hub.
        </p>
      </section>

      <section id="member-access" class="content-section member-access">
        <h2>Member Login & Profile</h2>
        <div class="auth-grid">
          <form id="login-form" class="info-card" aria-describedby="login-help">
            <h3>Sign In</h3>
            <label for="login-identifier">Username or Email</label>
            <input
              id="login-identifier"
              name="identifier"
              type="text"
              autocomplete="username"
              required
            />

            <label for="login-password">Password</label>
            <input
              id="login-password"
              name="password"
              type="password"
              autocomplete="current-password"
              required
            />

            <button type="submit">Sign In</button>
            <p id="login-help" class="form-helper">
              Credentials are securely managed with Amazon Cognito User Pools.
              Use the same username or email you registered with.
            </p>
          </form>

          <form id="signup-form" class="info-card" aria-describedby="signup-help">
            <h3>Create Account</h3>
            <label for="signup-email">Email</label>
            <input
              id="signup-email"
              name="email"
              type="email"
              autocomplete="email"
              inputmode="email"
              required
            />

            <label for="signup-username">Preferred Username (optional)</label>
            <input
              id="signup-username"
              name="username"
              type="text"
              autocomplete="username"
              placeholder="Leave blank to use your email"
              minlength="5"
              maxlength="20"
            />

            <label for="signup-password">Password</label>
            <input
              id="signup-password"
              name="password"
              type="password"
              autocomplete="new-password"
              minlength="8"
              title="At least 8 characters, 2 uppercase letters, 2 numbers, and 1 special character."
              required
            />
            <p class="form-helper">
              Password must include at least 8 characters, 2 uppercase letters, 2 numbers, and 1 special character.
            </p>

            <label for="signup-confirm">Confirm Password</label>
            <input
              id="signup-confirm"
              name="confirm-password"
              type="password"
              autocomplete="new-password"
              required
            />

            <button type="submit">Sign Up</button>
            <p id="signup-help" class="form-helper">
              New members receive a confirmation email after registration. Once
              verified, sign in to access your dashboard.
            </p>
          </form>

          <form
            id="profile-form"
            class="info-card hidden auth-full"
            aria-live="polite"
          >
            <h3>User Profile</h3>
            <div class="form-grid">
              <label for="profile-username">Username</label>
              <input id="profile-username" name="username" type="text" readonly />

              <label for="profile-first-name">First Name</label>
              <input id="profile-first-name" name="first-name" type="text" />

              <label for="profile-last-name">Last Name</label>
              <input id="profile-last-name" name="last-name" type="text" />

              <label for="profile-email">Email</label>
              <input id="profile-email" name="email" type="email" />

              <label for="profile-dob">Date of Birth</label>
              <input id="profile-dob" name="dob" type="date" />
            </div>
            <p class="age-indicator">
              Age: <span id="profile-age" data-age>--</span>
            </p>
            <p class="form-helper">
              Profile details sync with Cognito attributes. Updates appear here
              once saved through the member portal.
            </p>
            <div class="profile-actions">
              <button type="button" id="refresh-profile">Refresh Profile</button>
              <a class="button-secondary" href="members.html">Go to Members</a>
            </div>
          </form>
        </div>
      </section>

      <section class="content-section video-preview">
        <h2>On-Demand Programs</h2>
        <p>
          Browse curated YouTube playlists and premium course drops inside the
          <a href="video-library.html">Programs page</a>. Free members can
          purchase individual bundles, while paid members enjoy discounted
          access and exclusive releases.
        </p>
      </section>
    </main>

    <footer>
      &copy; <span id="year"></span> Align with Sophy. All rights reserved.
    </footer>

    <script src="main.js"></script>
    <script>
      document.getElementById("year").textContent = new Date().getFullYear();

      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const profileForm = document.getElementById("profile-form");
      const profileFields = {
        username: document.getElementById("profile-username"),
        firstName: document.getElementById("profile-first-name"),
        lastName: document.getElementById("profile-last-name"),
        email: document.getElementById("profile-email"),
        dob: document.getElementById("profile-dob"),
        age: document.getElementById("profile-age"),
      };
      const refreshBtn = document.getElementById("refresh-profile");

      const REGISTERED_USERS_KEY = "alignWithSophyRegisteredUsers";
      const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const USERNAME_REGEX = /^[A-Za-z0-9._-]+$/;

      function toggleProfileVisibility(show) {
        profileForm.classList.toggle("hidden", !show);
        if (!show) {
          profileForm.reset();
          profileFields.age.textContent = "--";
        }
      }

      function calculateAge(dateString) {
        if (!dateString) return "--";
        const dob = new Date(dateString);
        if (Number.isNaN(dob.getTime())) return "--";
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const hasHadBirthdayThisYear =
          today.getMonth() > dob.getMonth() ||
          (today.getMonth() === dob.getMonth() && today.getDate() >= dob.getDate());
        if (!hasHadBirthdayThisYear) {
          age -= 1;
        }
        return age >= 0 ? age : "--";
      }

      function populateProfile(profile) {
        profileFields.username.value = profile.username ?? "";
        profileFields.firstName.value = profile.firstName ?? "";
        profileFields.lastName.value = profile.lastName ?? "";
        profileFields.email.value = profile.email ?? "";
        profileFields.dob.value = profile.dob ?? "";
        profileFields.age.textContent = calculateAge(profileFields.dob.value);
      }

      function getRegisteredUsers() {
        try {
          const raw = localStorage.getItem(REGISTERED_USERS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (error) {
          console.warn("Unable to parse registered users", error);
          return [];
        }
      }

      function saveRegisteredUsers(users) {
        localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(users));
      }

      function findRegisteredUser(identifier) {
        if (!identifier) return undefined;
        const normalized = identifier.toLowerCase();
        return getRegisteredUsers().find(
          (entry) =>
            entry.email === normalized ||
            (entry.usernameLower && entry.usernameLower === normalized)
        );
      }

      function isUsernameValid(username) {
        return (
          username.length >= 5 &&
          username.length <= 20 &&
          USERNAME_REGEX.test(username)
        );
      }

      function validatePassword(password) {
        if (password.length < 8) {
          return {
            valid: false,
            message: "Password must be at least 8 characters long.",
          };
        }
        const uppercaseMatches = password.match(/[A-Z]/g) || [];
        const digitMatches = password.match(/[0-9]/g) || [];
        const specialMatches = password.match(/[^A-Za-z0-9]/g) || [];
        if (uppercaseMatches.length < 2) {
          return {
            valid: false,
            message: "Password needs at least 2 uppercase letters.",
          };
        }
        if (digitMatches.length < 2) {
          return {
            valid: false,
            message: "Password needs at least 2 numbers.",
          };
        }
        if (specialMatches.length < 1) {
          return {
            valid: false,
            message: "Password needs at least 1 special character.",
          };
        }
        return { valid: true };
      }

      function generateUsernameFromEmail(email, users) {
        const localPart = email.split("@")[0].replace(/[^A-Za-z0-9._-]/g, "");
        let base = localPart || "member";
        while (base.length < 5) {
          base += Math.floor(Math.random() * 10).toString();
        }
        base = base.slice(0, 20);
        let candidate = base;
        let suffix = 1;
        const taken = new Set(
          users
            .map((entry) => entry.usernameLower)
            .filter(Boolean)
        );
        while (taken.has(candidate.toLowerCase()) && suffix < 1000) {
          const trimmed = base.slice(
            0,
            Math.max(0, 20 - suffix.toString().length)
          );
          candidate = `${trimmed}${suffix}`;
          suffix += 1;
        }
        return candidate;
      }

      function mapUserToProfile(user) {
        return {
          username: user.username,
          email: user.emailDisplay ?? user.email,
          firstName: user.firstName ?? "Yoga",
          lastName: user.lastName ?? "Practitioner",
          dob: user.dob ?? "",
        };
      }

      async function authenticateWithCognito(identifier, password) {
        // TODO: Replace this placeholder with Amazon Cognito SDK integration.
        console.info(
          "Cognito authentication placeholder invoked. Replace authenticateWithCognito with live implementation."
        );

        const normalizedIdentifier = identifier.toLowerCase();
        const users = getRegisteredUsers();
        const user = users.find(
          (entry) =>
            entry.email === normalizedIdentifier ||
            (entry.usernameLower && entry.usernameLower === normalizedIdentifier)
        );

        if (!user) {
          throw new Error("No account found for that username or email.");
        }

        if (!password) {
          throw new Error("Password is required to sign in.");
        }

        if (user.password !== password) {
          throw new Error("Incorrect password. Please try again.");
        }

        if (!user.verified) {
          throw new Error("Please verify your email before signing in.");
        }

        if (
          user.verificationDeadline &&
          Date.now() > user.verificationDeadline &&
          !user.verified
        ) {
          throw new Error(
            "Email verification has expired. Please restart the sign-up process."
          );
        }

        return mapUserToProfile(user);
      }

      async function registerWithCognito({ email, username, password }) {
        // TODO: Replace this placeholder with Amazon Cognito sign-up integration.
        console.info(
          "Cognito registration placeholder invoked. Replace registerWithCognito with live implementation."
        );

        const normalizedEmail = email.toLowerCase();
        if (!EMAIL_REGEX.test(normalizedEmail)) {
          throw new Error("Please enter a valid email address.");
        }

        const trimmedUsername = username.trim();
        if (trimmedUsername && !isUsernameValid(trimmedUsername)) {
          throw new Error(
            "Username must be 5-20 characters using letters, numbers, dots, underscores, or hyphens."
          );
        }

        const passwordCheck = validatePassword(password);
        if (!passwordCheck.valid) {
          throw new Error(passwordCheck.message);
        }

        const users = getRegisteredUsers();
        if (users.some((entry) => entry.email === normalizedEmail)) {
          throw new Error("An account already exists with that email address.");
        }

        let usernameToStore =
          trimmedUsername ||
          generateUsernameFromEmail(normalizedEmail, users);

        if (
          users.some(
            (entry) =>
              entry.usernameLower &&
              entry.usernameLower === usernameToStore.toLowerCase()
          )
        ) {
          throw new Error("That username is already taken. Please choose another.");
        }

        const verificationDeadline = Date.now() + 1000 * 60 * 60 * 24 * 3;
        const newUser = {
          email: normalizedEmail,
          emailDisplay: email,
          username: usernameToStore,
          usernameLower: usernameToStore.toLowerCase(),
          password,
          verified: true, // Configure Cognito to keep users UNCONFIRMED until they verify email.
          verificationDeadline,
          createdAt: Date.now(),
        };

        users.push(newUser);
        saveRegisteredUsers(users);

        console.info(
          "Ensure your Cognito User Pool enforces email verification with a 3-day expiration."
        );

        return {
          email: email,
          username: usernameToStore,
          requiresConfirmation: true,
          verificationDeadline: new Date(verificationDeadline).toISOString(),
        };
      }

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const identifier = loginForm.identifier.value.trim();
        const password = loginForm.password.value;

        if (!identifier || !password) return;

        toggleProfileVisibility(false);

        try {
          const profile = await authenticateWithCognito(identifier, password);
          populateProfile(profile);
          toggleProfileVisibility(true);
          if (window.AuthNav?.setProfile) {
            window.AuthNav.setProfile(profile);
          }
          loginForm.reset();
        } catch (error) {
          console.error("Cognito sign-in failed", error);
          alert(
            error?.message ||
              "Sign-in could not be completed. Please check your credentials and try again."
          );
        }
      });

      if (signupForm) {
        signupForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const email = signupForm.email.value.trim();
          const username = signupForm.username.value.trim();
          const password = signupForm.password.value;
          const confirmPassword = signupForm["confirm-password"].value;

          if (!email || !password || !confirmPassword) return;
          if (password !== confirmPassword) {
            alert("Passwords do not match. Please try again.");
            return;
          }

          try {
            const response = await registerWithCognito({ email, username, password });
            loginForm.identifier.value = response.username || email;
            const verificationMessage = response.verificationDeadline
              ? ` Please verify your email before ${new Date(
                  response.verificationDeadline
                ).toLocaleString()}.`
              : "";
            alert(
              response.requiresConfirmation
                ? `Sign-up successful! Check your email to confirm your account.${verificationMessage}`
                : "Sign-up successful! You can now sign in."
            );
            signupForm.reset();
          } catch (error) {
            console.error("Cognito sign-up failed", error);
            alert(
              error?.message ||
                "We could not complete your sign-up. Please try again later."
            );
          }
        });
      }

      profileFields.dob.addEventListener("change", () => {
        profileFields.age.textContent = calculateAge(profileFields.dob.value);
      });

      refreshBtn.addEventListener("click", () => {
        const activeProfile = window.AuthNav?.getProfile
          ? window.AuthNav.getProfile()
          : null;
        const lookupValue =
          activeProfile?.username ||
          activeProfile?.email ||
          profileFields.email.value ||
          profileFields.username.value;

        if (!lookupValue) {
          alert("Please sign in to load your latest profile details.");
          return;
        }

        const userRecord = findRegisteredUser(lookupValue);
        if (!userRecord) {
          alert("Unable to refresh profile details right now.");
          return;
        }

        const profile = mapUserToProfile(userRecord);
        populateProfile(profile);
        if (window.AuthNav?.setProfile) {
          window.AuthNav.setProfile(profile);
        }
        alert("Profile refreshed from stored account data.");
      });

      document.addEventListener("auth:login", (event) => {
        if (!event.detail) return;
        populateProfile(event.detail);
        toggleProfileVisibility(true);
      });

      document.addEventListener("auth:logout", () => {
        toggleProfileVisibility(false);
        loginForm.reset();
      });

      const storedProfile = window.AuthNav?.getProfile
        ? window.AuthNav.getProfile()
        : null;
      if (storedProfile) {
        populateProfile(storedProfile);
        toggleProfileVisibility(true);
      } else {
        toggleProfileVisibility(false);
      }
    </script>
  </body>
</html>





